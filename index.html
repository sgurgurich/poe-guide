<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POE2 Act Guide</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="banner">
        <div class="banner-content">
            <div class="banner-logo">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <radialGradient id="goldGradient" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#d4af37;stop-opacity:1" />
                        </radialGradient>
                    </defs>
                    <!-- Decorative background -->
                    <circle cx="100" cy="100" r="95" fill="none" stroke="#8b4513" stroke-width="3" opacity="0.5"/>
                    <!-- Main text -->
                    <text x="100" y="110" font-size="48" font-weight="bold" text-anchor="middle" fill="url(#goldGradient)" letter-spacing="2">PATH</text>
                    <text x="100" y="160" font-size="36" font-weight="bold" text-anchor="middle" fill="url(#goldGradient)">OF EXILE 2</text>
                    <!-- Decorative elements -->
                    <circle cx="30" cy="100" r="8" fill="#d4af37" opacity="0.7"/>
                    <circle cx="170" cy="100" r="8" fill="#d4af37" opacity="0.7"/>
                </svg>
            </div>
            <div class="banner-text">
                <h1>Path of Exile 2 - Act Guide</h1>
            </div>
        </div>
    </div>
    <div class="container">
        <div id="content" class="loading">Loading guide...</div>
    </div>

    <script>
        // Expandable Section State Management
        const getExpandedSections = () => {
            const saved = localStorage.getItem('expandedSections');
            return saved ? JSON.parse(saved) : [];
        };

        const saveExpandedSections = (sections) => {
            localStorage.setItem('expandedSections', JSON.stringify(sections));
        };

        const addExpandedSection = (sectionId) => {
            const sections = getExpandedSections();
            if (!sections.includes(sectionId)) {
                sections.push(sectionId);
                saveExpandedSections(sections);
            }
        };

        const removeExpandedSection = (sectionId) => {
            const sections = getExpandedSections();
            const filtered = sections.filter(id => id !== sectionId);
            saveExpandedSections(filtered);
        };

        const isSectionExpanded = (sectionId) => {
            return getExpandedSections().includes(sectionId);
        };

        // Checkbox State Management
        const getCheckboxState = () => {
            const saved = localStorage.getItem('checkboxState');
            return saved ? JSON.parse(saved) : {};
        };

        const setCheckboxState = (id, checked) => {
            const state = getCheckboxState();
            if (checked) {
                state[id] = true;
            } else {
                delete state[id];
            }
            localStorage.setItem('checkboxState', JSON.stringify(state));
        };

        const isCheckboxChecked = (id) => {
            return getCheckboxState()[id] === true;
        };

        // Load Guide
        async function loadActFromFile(actNumber) {
            try {
                const response = await fetch(`data/act${actNumber}.xml`);
                if (!response.ok) {
                    throw new Error(`Failed to load act${actNumber}.xml`);
                }
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                    throw new Error(`XML parsing error in act${actNumber}.xml`);
                }
                
                return xmlDoc.getElementsByTagName('act')[0];
            } catch (error) {
                console.error(`Error loading act ${actNumber}:`, error);
                return null;
            }
        }

        async function loadInterludesFromFile() {
            try {
                const response = await fetch('data/interludes.xml');
                if (!response.ok) {
                    throw new Error('Failed to load interludes.xml');
                }
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                    throw new Error('XML parsing error in interludes.xml');
                }
                
                return xmlDoc.getElementsByTagName('interludes')[0];
            } catch (error) {
                console.error('Error loading interludes:', error);
                return null;
            }
        }

        async function loadGuide() {
            try {
                const content = document.getElementById('content');
                content.innerHTML = '';
                
                // Load all 4 acts
                for (let i = 1; i <= 4; i++) {
                    const act = await loadActFromFile(i);
                    if (!act) continue;
                    
                    const actNumber = act.getAttribute('number');
                    const actSectionId = `act-${actNumber}`;
                    const actDiv = document.createElement('div');
                    actDiv.className = 'act';
                    
                    const actHeader = document.createElement('div');
                    actHeader.className = 'act-header';
                    actHeader.style.cursor = 'pointer';
                    
                    const actTitle = document.createElement('div');
                    actTitle.className = 'act-title';
                    actTitle.textContent = `Act ${actNumber}`;
                    
                    const actToggle = document.createElement('span');
                    actToggle.className = 'act-toggle';
                    
                    actHeader.appendChild(actTitle);
                    actHeader.appendChild(actToggle);
                    actDiv.appendChild(actHeader);
                    
                    // Add background image for acts 1 and 2
                    if (actNumber === '1' || actNumber === '2') {
                        const actImage = document.createElement('div');
                        actImage.className = 'act-image';
                        const imageName = actNumber === '1' ? 'poe2-act-1.webp' : 'poe2-act-2.webp';
                        actImage.style.backgroundImage = `url('media/${imageName}')`;
                        if (actNumber === '1') {
                            actImage.style.backgroundPosition = 'center 75%';
                        }
                        actHeader.appendChild(actImage);
                    }
                    
                    // Add background image for acts 3, 4 and interludes (ready for image files)
                    if (actNumber === '3' || actNumber === '4' || actNumber === 'interludes') {
                        const actImage = document.createElement('div');
                        actImage.className = 'act-image';
                        const imageName = actNumber === '3' ? 'poe2-act-3.png' : actNumber === '4' ? 'poe2-act-4.png' : 'poe2-interludes.webp';
                        actImage.style.backgroundImage = `url('media/${imageName}')`;
                        actHeader.appendChild(actImage);
                    }
                    
                    const actContent = document.createElement('div');
                    actContent.className = 'act-content';
                    
                    const isExpanded = isSectionExpanded(actSectionId);
                    actContent.style.display = isExpanded ? 'block' : 'none';
                    actToggle.textContent = isExpanded ? '▼' : '▶';
                    if (isExpanded) {
                        actDiv.classList.add('expanded');
                    }
                    
                    const steps = act.getElementsByTagName('step');
                    
                    if (steps.length === 0) {
                        const emptyDiv = document.createElement('div');
                        emptyDiv.className = 'empty-act';
                        emptyDiv.textContent = 'Content coming soon...';
                        actContent.appendChild(emptyDiv);
                    } else {
                        for (let step of steps) {
                            const stepNumber = step.getAttribute('number');
                            const nameEl = step.getElementsByTagName('name')[0];
                            const name = nameEl ? nameEl.textContent : 'Unnamed';
                            
                            const stepDiv = document.createElement('div');
                            stepDiv.className = 'step';
                            
                            const stepNameDiv = document.createElement('div');
                            stepNameDiv.className = 'step-name';
                            
                            const stepCheckboxId = `step-${actNumber}-${stepNumber}`;
                            const stepCheckbox = document.createElement('input');
                            stepCheckbox.type = 'checkbox';
                            stepCheckbox.className = 'step-checkbox';
                            stepCheckbox.id = stepCheckboxId;
                            stepCheckbox.checked = isCheckboxChecked(stepCheckboxId);
                            
                            if (stepCheckbox.checked) {
                                stepNameDiv.classList.add('completed');
                            }
                            
                            stepCheckbox.addEventListener('change', function() {
                                stepNameDiv.classList.toggle('completed', this.checked);
                                setCheckboxState(stepCheckboxId, this.checked);
                            });
                            
                            stepNameDiv.appendChild(stepCheckbox);
                            const stepLabel = document.createElement('span');
                            stepLabel.textContent = `${stepNumber}) ${name}`;
                            stepNameDiv.appendChild(stepLabel);
                            
                            stepDiv.appendChild(stepNameDiv);
                            
                            // Add click handler to step name to toggle all checkboxes
                            stepNameDiv.addEventListener('click', function(e) {
                                if (e.target !== stepCheckbox) {
                                    const allCheckboxes = [stepCheckbox];
                                    stepDiv.querySelectorAll('.objective-checkbox').forEach(cb => {
                                        allCheckboxes.push(cb);
                                    });
                                    
                                    const shouldCheck = !stepCheckbox.checked;
                                    allCheckboxes.forEach(checkbox => {
                                        checkbox.checked = shouldCheck;
                                        checkbox.dispatchEvent(new Event('change'));
                                    });
                                }
                            });
                            
                            const objectivesEl = step.getElementsByTagName('objectives')[0];
                            if (objectivesEl) {
                                const objectivesList = document.createElement('ul');
                                objectivesList.className = 'objectives-list';
                                
                                const objectives = objectivesEl.getElementsByTagName('objective');
                                let objIndex = 0;
                                for (let obj of objectives) {
                                    const objItem = document.createElement('li');
                                    objItem.className = 'objective-item';
                                    
                                    const objCheckboxId = `objective-${actNumber}-${stepNumber}-${objIndex}`;
                                    const objCheckbox = document.createElement('input');
                                    objCheckbox.type = 'checkbox';
                                    objCheckbox.className = 'objective-checkbox';
                                    objCheckbox.id = objCheckboxId;
                                    objCheckbox.checked = isCheckboxChecked(objCheckboxId);
                                    
                                    if (objCheckbox.checked) {
                                        objItem.classList.add('completed');
                                    }
                                    
                                    objCheckbox.addEventListener('change', function() {
                                        objItem.classList.toggle('completed', this.checked);
                                        setCheckboxState(objCheckboxId, this.checked);
                                    });
                                    
                                    objItem.appendChild(objCheckbox);
                                    const objLabel = document.createElement('span');
                                    objLabel.textContent = obj.textContent;
                                    objItem.appendChild(objLabel);
                                    
                                    objectivesList.appendChild(objItem);
                                    objIndex++;
                                }
                                
                                stepDiv.appendChild(objectivesList);
                            }
                            
                            actContent.appendChild(stepDiv);
                        }
                    }
                    
                    actDiv.appendChild(actContent);
                    
                    // Add click handler to toggle expand/collapse
                    actHeader.addEventListener('click', () => {
                        const isOpen = actContent.style.display !== 'none';
                        actContent.style.display = isOpen ? 'none' : 'block';
                        actToggle.textContent = isOpen ? '▶' : '▼';
                        
                        if (isOpen) {
                            removeExpandedSection(actSectionId);
                            actDiv.classList.remove('expanded');
                        } else {
                            addExpandedSection(actSectionId);
                            actDiv.classList.add('expanded');
                        }
                    });
                    
                    content.appendChild(actDiv);
                }
                
                // Load Interludes
                const interludes = await loadInterludesFromFile();
                if (interludes) {
                    const interludeSectionId = 'interludes';
                    const interludeDiv = document.createElement('div');
                    interludeDiv.className = 'act';
                    
                    const interludeHeader = document.createElement('div');
                    interludeHeader.className = 'act-header';
                    interludeHeader.style.cursor = 'pointer';
                    
                    const interludeTitle = document.createElement('div');
                    interludeTitle.className = 'act-title';
                    interludeTitle.textContent = 'Interludes';
                    
                    const interludeToggle = document.createElement('span');
                    interludeToggle.className = 'act-toggle';
                    
                    interludeHeader.appendChild(interludeTitle);
                    interludeHeader.appendChild(interludeToggle);
                    interludeDiv.appendChild(interludeHeader);
                    
                    const interludeContent = document.createElement('div');
                    interludeContent.className = 'act-content';
                    
                    const isInterludeExpanded = isSectionExpanded(interludeSectionId);
                    interludeContent.style.display = isInterludeExpanded ? 'block' : 'none';
                    interludeToggle.textContent = isInterludeExpanded ? '▼' : '▶';
                    
                    const interludeEmpty = document.createElement('div');
                    interludeEmpty.className = 'empty-act';
                    interludeEmpty.textContent = 'Content coming soon...';
                    interludeContent.appendChild(interludeEmpty);
                    
                    interludeDiv.appendChild(interludeContent);
                    
                    // Add click handler to toggle expand/collapse
                    interludeHeader.addEventListener('click', () => {
                        const isOpen = interludeContent.style.display !== 'none';
                        interludeContent.style.display = isOpen ? 'none' : 'block';
                        interludeToggle.textContent = isOpen ? '▶' : '▼';
                        
                        if (isOpen) {
                            removeExpandedSection(interludeSectionId);
                        } else {
                            addExpandedSection(interludeSectionId);
                        }
                    });
                    
                    content.appendChild(interludeDiv);
                }
            } catch (error) {
                const content = document.getElementById('content');
                content.innerHTML = `<div class="error">Error loading guide: ${error.message}<br><br>Make sure the data directory with individual XML files exists.</div>`;
                console.error('Error:', error);
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            loadGuide();
        });
    </script>
</body>
</html>