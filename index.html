<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POE2 Act Guide</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="header">
        <h1>Path of Exile 2 - Act Guide</h1>
        <div class="theme-toggle">
            <button class="theme-btn active" data-theme="dark">Dark</button>
            <button class="theme-btn" data-theme="light">Light</button>
        </div>
    </div>
    <div class="container">
        <div id="content" class="loading">Loading guide...</div>
    </div>

    <script>
        // Expandable Section State Management
        const getExpandedSections = () => {
            const saved = localStorage.getItem('expandedSections');
            return saved ? JSON.parse(saved) : [];
        };

        const saveExpandedSections = (sections) => {
            localStorage.setItem('expandedSections', JSON.stringify(sections));
        };

        const addExpandedSection = (sectionId) => {
            const sections = getExpandedSections();
            if (!sections.includes(sectionId)) {
                sections.push(sectionId);
                saveExpandedSections(sections);
            }
        };

        const removeExpandedSection = (sectionId) => {
            const sections = getExpandedSections();
            const filtered = sections.filter(id => id !== sectionId);
            saveExpandedSections(filtered);
        };

        const isSectionExpanded = (sectionId) => {
            return getExpandedSections().includes(sectionId);
        };

        // Checkbox State Management
        const getCheckboxState = () => {
            const saved = localStorage.getItem('checkboxState');
            return saved ? JSON.parse(saved) : {};
        };

        const setCheckboxState = (id, checked) => {
            const state = getCheckboxState();
            if (checked) {
                state[id] = true;
            } else {
                delete state[id];
            }
            localStorage.setItem('checkboxState', JSON.stringify(state));
        };

        const isCheckboxChecked = (id) => {
            return getCheckboxState()[id] === true;
        };

        // Theme Management
        const initializeTheme = () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
        };

        const applyTheme = (theme) => {
            const body = document.body;
            const buttons = document.querySelectorAll('.theme-btn');
            
            if (theme === 'light') {
                body.classList.add('light-mode');
            } else {
                body.classList.remove('light-mode');
            }
            
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === theme) {
                    btn.classList.add('active');
                }
            });
            
            localStorage.setItem('theme', theme);
        };

        // Theme Button Listeners
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                applyTheme(btn.dataset.theme);
            });
        });

        // Load Guide
        async function loadGuide() {
            try {
                const response = await fetch('data/poe2_act_guide.xml');
                if (!response.ok) {
                    throw new Error('Failed to load XML file');
                }
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                    throw new Error('XML parsing error');
                }
                
                const content = document.getElementById('content');
                content.innerHTML = '';
                
                const acts = xmlDoc.getElementsByTagName('act');
                
                for (let act of acts) {
                    const actNumber = act.getAttribute('number');
                    const actSectionId = `act-${actNumber}`;
                    const actDiv = document.createElement('div');
                    actDiv.className = 'act';
                    
                    const actHeader = document.createElement('div');
                    actHeader.className = 'act-header';
                    actHeader.style.cursor = 'pointer';
                    
                    const actTitle = document.createElement('div');
                    actTitle.className = 'act-title';
                    actTitle.textContent = `Act ${actNumber}`;
                    
                    const actToggle = document.createElement('span');
                    actToggle.className = 'act-toggle';
                    
                    actHeader.appendChild(actToggle);
                    actHeader.appendChild(actTitle);
                    actDiv.appendChild(actHeader);
                    
                    const actContent = document.createElement('div');
                    actContent.className = 'act-content';
                    
                    const isExpanded = isSectionExpanded(actSectionId);
                    actContent.style.display = isExpanded ? 'block' : 'none';
                    actToggle.textContent = isExpanded ? '▼' : '▶';
                    
                    const steps = act.getElementsByTagName('step');
                    
                    if (steps.length === 0) {
                        const emptyDiv = document.createElement('div');
                        emptyDiv.className = 'empty-act';
                        emptyDiv.textContent = 'Content coming soon...';
                        actContent.appendChild(emptyDiv);
                    } else {
                        for (let step of steps) {
                            const stepNumber = step.getAttribute('number');
                            const nameEl = step.getElementsByTagName('name')[0];
                            const name = nameEl ? nameEl.textContent : 'Unnamed';
                            
                            const stepDiv = document.createElement('div');
                            stepDiv.className = 'step';
                            
                            const stepNameDiv = document.createElement('div');
                            stepNameDiv.className = 'step-name';
                            
                            const stepCheckboxId = `step-${actNumber}-${stepNumber}`;
                            const stepCheckbox = document.createElement('input');
                            stepCheckbox.type = 'checkbox';
                            stepCheckbox.className = 'step-checkbox';
                            stepCheckbox.id = stepCheckboxId;
                            stepCheckbox.checked = isCheckboxChecked(stepCheckboxId);
                            
                            if (stepCheckbox.checked) {
                                stepNameDiv.classList.add('completed');
                            }
                            
                            stepCheckbox.addEventListener('change', function() {
                                stepNameDiv.classList.toggle('completed', this.checked);
                                setCheckboxState(stepCheckboxId, this.checked);
                            });
                            
                            stepNameDiv.appendChild(stepCheckbox);
                            const stepLabel = document.createElement('span');
                            stepLabel.textContent = `${stepNumber}) ${name}`;
                            stepNameDiv.appendChild(stepLabel);
                            
                            stepDiv.appendChild(stepNameDiv);
                            
                            const objectivesEl = step.getElementsByTagName('objectives')[0];
                            if (objectivesEl) {
                                const objectivesList = document.createElement('ul');
                                objectivesList.className = 'objectives-list';
                                
                                const objectives = objectivesEl.getElementsByTagName('objective');
                                let objIndex = 0;
                                for (let obj of objectives) {
                                    const objItem = document.createElement('li');
                                    objItem.className = 'objective-item';
                                    
                                    const objCheckboxId = `objective-${actNumber}-${stepNumber}-${objIndex}`;
                                    const objCheckbox = document.createElement('input');
                                    objCheckbox.type = 'checkbox';
                                    objCheckbox.className = 'objective-checkbox';
                                    objCheckbox.id = objCheckboxId;
                                    objCheckbox.checked = isCheckboxChecked(objCheckboxId);
                                    
                                    if (objCheckbox.checked) {
                                        objItem.classList.add('completed');
                                    }
                                    
                                    objCheckbox.addEventListener('change', function() {
                                        objItem.classList.toggle('completed', this.checked);
                                        setCheckboxState(objCheckboxId, this.checked);
                                    });
                                    
                                    objItem.appendChild(objCheckbox);
                                    const objLabel = document.createElement('span');
                                    objLabel.textContent = obj.textContent;
                                    objItem.appendChild(objLabel);
                                    
                                    objectivesList.appendChild(objItem);
                                    objIndex++;
                                }
                                
                                stepDiv.appendChild(objectivesList);
                            }
                            
                            actContent.appendChild(stepDiv);
                        }
                    }
                    
                    actDiv.appendChild(actContent);
                    
                    // Add click handler to toggle expand/collapse
                    actHeader.addEventListener('click', () => {
                        const isOpen = actContent.style.display !== 'none';
                        actContent.style.display = isOpen ? 'none' : 'block';
                        actToggle.textContent = isOpen ? '▶' : '▼';
                        
                        if (isOpen) {
                            removeExpandedSection(actSectionId);
                        } else {
                            addExpandedSection(actSectionId);
                        }
                    });
                    
                    content.appendChild(actDiv);
                }
                
                // Handle Interludes
                const interludes = xmlDoc.getElementsByTagName('interludes')[0];
                if (interludes) {
                    const interludeSectionId = 'interludes';
                    const interludeDiv = document.createElement('div');
                    interludeDiv.className = 'act';
                    
                    const interludeHeader = document.createElement('div');
                    interludeHeader.className = 'act-header';
                    interludeHeader.style.cursor = 'pointer';
                    
                    const interludeTitle = document.createElement('div');
                    interludeTitle.className = 'act-title';
                    interludeTitle.textContent = 'Interludes';
                    
                    const interludeToggle = document.createElement('span');
                    interludeToggle.className = 'act-toggle';
                    
                    interludeHeader.appendChild(interludeToggle);
                    interludeHeader.appendChild(interludeTitle);
                    interludeDiv.appendChild(interludeHeader);
                    
                    const interludeContent = document.createElement('div');
                    interludeContent.className = 'act-content';
                    
                    const isInterludeExpanded = isSectionExpanded(interludeSectionId);
                    interludeContent.style.display = isInterludeExpanded ? 'block' : 'none';
                    interludeToggle.textContent = isInterludeExpanded ? '▼' : '▶';
                    
                    const interludeEmpty = document.createElement('div');
                    interludeEmpty.className = 'empty-act';
                    interludeEmpty.textContent = 'Content coming soon...';
                    interludeContent.appendChild(interludeEmpty);
                    
                    interludeDiv.appendChild(interludeContent);
                    
                    // Add click handler to toggle expand/collapse
                    interludeHeader.addEventListener('click', () => {
                        const isOpen = interludeContent.style.display !== 'none';
                        interludeContent.style.display = isOpen ? 'none' : 'block';
                        interludeToggle.textContent = isOpen ? '▶' : '▼';
                        
                        if (isOpen) {
                            removeExpandedSection(interludeSectionId);
                        } else {
                            addExpandedSection(interludeSectionId);
                        }
                    });
                    
                    content.appendChild(interludeDiv);
                }
            } catch (error) {
                const content = document.getElementById('content');
                content.innerHTML = `<div class="error">Error loading guide: ${error.message}<br><br>Make sure poe2_act_guide.xml is in the same directory as this HTML file.</div>`;
                console.error('Error:', error);
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            initializeTheme();
            loadGuide();
        });
    </script>
</body>
</html>